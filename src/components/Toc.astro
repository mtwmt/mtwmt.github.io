---
interface Props {
  headings: Array<{
    depth: number;
    slug: string;
    text: string;
  }>;
}
const { headings } = Astro.props;

// 只顯示 H2 和 H3
const toc = headings.filter((h) => h.depth <= 3);
---

{
  !!toc.length && (
    <ul data-blog-toc class="leading-normal sticky top-0 max-h-screen overflow-y-auto">
      <li class="min-h-12 border-b border-primary-700 bg-primary-900 px-3 py-3 text-primary-50 flex items-center break-words font-bold">
        文章導覽
      </li>
      {toc.map((heading) => (
        <li class="min-h-10 border-b border-primary-700 text-primary-50 hover:bg-primary-700 hover:text-white">
          <a
            class={`block w-full cursor-pointer px-3 py-2 break-words ${heading.depth === 3 ? "pl-6 text-sm" : "font-medium"}`}
            href={`#${heading.slug}`}
            aria-label={`Scroll to section: ${heading.text}`}
          >
            {heading.text}
          </a>
        </li>
      ))}
    </ul>
  )
}

<script>
  const setCurrent: IntersectionObserverCallback = (entries) => {
    for (let entry of entries) {
      const { id } = entry.target;
      const tocHeadingEl = document.querySelector(
        `[data-blog-toc] a[href="#${id}"]`
      );
      if (!tocHeadingEl) return;
      if (entry.isIntersecting) {
        document
          .querySelectorAll('[data-blog-toc] a')
          .forEach((e) => e.classList.remove('active'));
        tocHeadingEl.classList.add('active');
      }
    }
  };

  const observerOption: IntersectionObserverInit = {
    root: null,
    rootMargin: '0px 0px -180px',
    threshold: 1.0,
  };
  const headingObserver = new IntersectionObserver(setCurrent, observerOption);
  document
    .querySelectorAll('article :is(h2,h3)')
    .forEach((heading) => headingObserver.observe(heading));

  // 點擊 TOC 連結時自動關閉 sidebar (僅手機版)
  document.querySelectorAll('[data-blog-toc] a').forEach((link) => {
    link.addEventListener('click', () => {
      const navToggle = document.getElementById('nav-toggle') as HTMLInputElement;
      if (navToggle && window.innerWidth < 1024) {
        navToggle.checked = false;
      }
    });
  });
</script>